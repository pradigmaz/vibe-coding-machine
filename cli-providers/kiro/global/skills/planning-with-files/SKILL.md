# Planning with Files Skill

## Назначение

Реализация Manus-style file-based planning для сложных задач. Создает `task_plan.md`, `findings.md`, `progress.md` для управления контекстом и прогрессом. Используется всеми агентами при работе над сложными многошаговыми задачами (>5 tool calls), исследовательскими проектами, или задачами требующими организации.

**Основано на методологии Manus** — компании приобретенной Meta за $2 млрд, которая достигла $100M+ выручки за 8 месяцев благодаря context engineering.

## Ключевая идея

```
Контекстное окно = RAM (временная, ограниченная)
Файловая система = Диск (постоянная, неограниченная)

→ Всё важное записывается на диск
```

## Три основных файла

| Файл | Назначение | Когда обновлять |
|------|-----------|-----------------|
| `task_plan.md` | Фазы работы, прогресс, решения | После каждой фазы |
| `findings.md` | Исследования, открытия, решения | После ЛЮБОГО открытия |
| `progress.md` | Лог сессии, результаты тестов | На протяжении всей сессии |

## Когда использовать

### ✅ Используй для

- Многошаговых задач (3+ шага)
- Исследовательских задач
- Создания/построения проектов
- Задач требующих >5 tool calls
- Всего что требует организации

### ❌ Пропускай для

- Простых вопросов
- Редактирования одного файла
- Быстрых поисков
- Задач <3 шагов

## Quick Start

Перед ЛЮБОЙ сложной задачей создай три файла в корне проекта:

```
Planning Files Setup:
- [ ] Создай task_plan.md (используй шаблон ниже)
- [ ] Создай findings.md (используй шаблон ниже)  
- [ ] Создай progress.md (используй шаблон ниже)
- [ ] Перечитывай task_plan.md перед важными решениями
- [ ] Обновляй статусы фаз после завершения
- [ ] Логируй все ошибки в таблицу
```

**Автоматизация через Kiro Hooks** (опционально):
- Можно настроить хук "On File Save" для автоматического напоминания обновить task_plan.md
- Можно настроить хук "Manual Trigger" для проверки завершения всех фаз
- См. секцию "Интеграция с Kiro Hooks" ниже

## Шаблон task_plan.md

```markdown
# Task Plan: [Краткое описание]

## Цель
[Одно предложение описывающее конечное состояние]

## Текущая фаза
Phase 1

## Фазы

### Phase 1: Requirements & Discovery
- [ ] Понять намерение пользователя
- [ ] Определить ограничения и требования
- [ ] Задокументировать находки в findings.md
- **Status:** in_progress

### Phase 2: Planning & Structure
- [ ] Определить технический подход
- [ ] Создать структуру проекта если нужно
- [ ] Задокументировать решения с обоснованием
- **Status:** pending

### Phase 3: Implementation
- [ ] Выполнить план шаг за шагом
- [ ] Записать код в файлы перед выполнением
- [ ] Тестировать инкрементально
- **Status:** pending

### Phase 4: Testing & Verification
- [ ] Проверить что все требования выполнены
- [ ] Задокументировать результаты тестов в progress.md
- [ ] Исправить найденные проблемы
- **Status:** pending

### Phase 5: Delivery
- [ ] Проверить все выходные файлы
- [ ] Убедиться что deliverables полные
- [ ] Доставить пользователю
- **Status:** pending

## Ключевые вопросы
1. [Вопрос на который нужно ответить]
2. [Вопрос на который нужно ответить]

## Принятые решения
| Решение | Обоснование |
|---------|-------------|
|         |             |

## Встреченные ошибки
| Ошибка | Попытка | Решение |
|--------|---------|---------|
|        | 1       |         |

## Заметки
- Обновляй статус фазы: pending → in_progress → complete
- Перечитывай план перед важными решениями (манипуляция вниманием)
- Логируй ВСЕ ошибки - они помогают избежать повторения
```

## Шаблон findings.md

```markdown
# Findings & Decisions

## Требования
<!-- Что запросил пользователь -->
-

## Результаты исследований
<!-- Ключевые открытия из поиска, документации, exploration -->
-

## Технические решения
<!-- Архитектурные и имплементационные выборы с обоснованием -->
| Решение | Обоснование |
|---------|-------------|
|         |             |

## Встреченные проблемы
<!-- Проблемы и как они были решены -->
| Проблема | Решение |
|----------|---------|
|          |         |

## Ресурсы
<!-- URLs, пути к файлам, API references -->
-

## Визуальные/Браузерные находки
<!-- КРИТИЧНО: Обновляй после каждых 2 view/browser операций -->
<!-- Мультимодальный контент должен быть захвачен как текст немедленно -->
-

---
*Обновляй этот файл после каждых 2 view/browser/search операций*
*Это предотвращает потерю визуальной информации*
```

## Шаблон progress.md

```markdown
# Progress Log

## Session: [ДАТА]

### Phase 1: [Название]
- **Status:** in_progress
- **Started:** [timestamp]
- Actions taken:
  -
- Files created/modified:
  -

### Phase 2: [Название]
- **Status:** pending
- Actions taken:
  -
- Files created/modified:
  -

## Результаты тестов
| Тест | Вход | Ожидаемо | Фактически | Статус |
|------|------|----------|------------|--------|
|      |      |          |            |        |

## Лог ошибок
<!-- Храни ВСЕ ошибки - они помогают избежать повторения -->
| Timestamp | Ошибка | Попытка | Решение |
|-----------|--------|---------|---------|
|           |        | 1       |         |

## Проверка 5-ти вопросов
<!-- Если можешь ответить на эти вопросы, контекст в порядке -->
| Вопрос | Ответ |
|--------|-------|
| Где я? | Phase X |
| Куда я иду? | Оставшиеся фазы |
| Какая цель? | [формулировка цели] |
| Что я узнал? | См. findings.md |
| Что я сделал? | См. выше |

---
*Обновляй после завершения каждой фазы или при ошибках*
```

## Критические правила

### 1. Создавай план первым
Никогда не начинай сложную задачу без `task_plan.md`. Это не обсуждается.

### 2. Правило 2-х действий
> "После каждых 2 view/browser/search операций НЕМЕДЛЕННО сохраняй ключевые находки в текстовые файлы."

Это предотвращает потерю визуальной/мультимодальной информации.

### 3. Читай перед решением
Перед важными решениями читай файл плана. Это держит цели в окне внимания.

### 4. Обновляй после действия
После завершения любой фазы:
- Меняй статус: `in_progress` → `complete`
- Логируй все ошибки
- Отмечай созданные/измененные файлы

### 5. Логируй ВСЕ ошибки
Каждая ошибка идет в файл плана. Это создает базу знаний и предотвращает повторение.

```markdown
## Встреченные ошибки
| Ошибка | Попытка | Решение |
|--------|---------|---------|
| FileNotFoundError | 1 | Создан default config |
| API timeout | 2 | Добавлена retry логика |
```

### 6. Никогда не повторяй неудачи
```
if action_failed:
    next_action != same_action
```
Отслеживай что пробовал. Меняй подход.

## Протокол 3-х попыток при ошибках

```
ПОПЫТКА 1: Диагностика и исправление
  → Внимательно читай ошибку
  → Определи корневую причину
  → Примени целевое исправление

ПОПЫТКА 2: Альтернативный подход
  → Та же ошибка? Попробуй другой метод
  → Другой инструмент? Другую библиотеку?
  → НИКОГДА не повторяй точно такое же действие

ПОПЫТКА 3: Более широкое переосмысление
  → Поставь под сомнение предположения
  → Ищи решения
  → Рассмотри обновление плана

ПОСЛЕ 3-Х НЕУДАЧ: Эскалация к пользователю
  → Объясни что пробовал
  → Поделись конкретной ошибкой
  → Попроси совета
```

## Матрица решений: Читать vs Писать

| Ситуация | Действие | Причина |
|----------|----------|---------|
| Только что записал файл | НЕ читай | Содержимое еще в контексте |
| Просмотрел изображение/PDF | Запиши находки СЕЙЧАС | Мультимодальное → текст до потери |
| Браузер вернул данные | Запиши в файл | Скриншоты не сохраняются |
| Начинаешь новую фазу | Читай план/находки | Переориентируйся если контекст устарел |
| Произошла ошибка | Читай соответствующий файл | Нужно текущее состояние для исправления |
| Возобновление после паузы | Читай все файлы планирования | Восстанови состояние |

## Тест 5-ти вопросов для перезагрузки

Если можешь ответить на эти вопросы, управление контекстом в порядке:

| Вопрос | Источник ответа |
|--------|-----------------|
| Где я? | Текущая фаза в task_plan.md |
| Куда я иду? | Оставшиеся фазы |
| Какая цель? | Формулировка цели в плане |
| Что я узнал? | findings.md |
| Что я сделал? | progress.md |

## Принципы Manus

### Принцип 1: Файловая система как внешняя память

> "Markdown - это моя 'рабочая память' на диске."

**Формула**:
```
Context Window = RAM (volatile, limited)
Filesystem = Disk (persistent, unlimited)
```

**Сжатие должно быть восстанавливаемым**:
- Храни URL даже если веб-контент удален
- Храни пути к файлам при удалении содержимого
- Никогда не теряй указатель на полные данные

### Принцип 2: Манипулируй вниманием через повторение

> "Создает и обновляет todo.md на протяжении задач чтобы протолкнуть глобальный план в недавний attention span модели."

**Проблема**: После ~50 tool calls модели забывают исходные цели ("lost in the middle" эффект).

**Решение**: Перечитывай `task_plan.md` перед каждым решением. Цели появляются в окне внимания.

```
Начало контекста: [Исходная цель - далеко, забыта]
...много tool calls...
Конец контекста: [Недавно прочитанный task_plan.md - получает ВНИМАНИЕ!]
```

### Принцип 3: Оставляй неправильные шаги в контексте

> "Оставь неправильные повороты в контексте."

**Почему**:
- Неудачные действия со стек-трейсами позволяют модели неявно обновлять убеждения
- Уменьшает повторение ошибок
- Восстановление после ошибок - "один из самых четких сигналов ИСТИННОГО агентского поведения"

## Примеры использования

### Пример 1: Исследовательская задача

**Запрос**: "Исследуй преимущества утренних упражнений и напиши summary"

#### Loop 1: Создай план
```bash
# Создай task_plan.md
```

```markdown
# Task Plan: Исследование преимуществ утренних упражнений

## Цель
Создать исследовательский summary о преимуществах утренних упражнений.

## Фазы
- [ ] Phase 1: Создать этот план ✓
- [ ] Phase 2: Поиск и сбор источников
- [ ] Phase 3: Синтез находок
- [ ] Phase 4: Доставка summary

## Ключевые вопросы
1. Какие преимущества для физического здоровья?
2. Какие преимущества для ментального здоровья?
3. Какие научные исследования это подтверждают?

## Status
**Currently in Phase 1** - Создание плана
```

#### Loop 2: Исследование
```bash
# Освежи цели
cat task_plan.md | head -30

# Поиск
# WebSearch "morning exercise benefits"

# Сохрани находки
# Write findings.md

# Обнови план
# Edit task_plan.md - отметь Phase 2 complete
```

#### Loop 3: Синтез
```bash
# Освежи цели
cat task_plan.md | head -30

# Получи находки
cat findings.md

# Создай summary
# Write morning_exercise_summary.md

# Обнови план
# Edit task_plan.md - отметь Phase 3 complete
```

### Пример 2: Bug Fix

**Запрос**: "Исправь login bug в authentication модуле"

#### task_plan.md
```markdown
# Task Plan: Исправление Login Bug

## Цель
Идентифицировать и исправить bug предотвращающий успешный login.

## Фазы
- [x] Phase 1: Понять bug report ✓
- [x] Phase 2: Найти соответствующий код ✓
- [ ] Phase 3: Идентифицировать корневую причину (ТЕКУЩАЯ)
- [ ] Phase 4: Реализовать fix
- [ ] Phase 5: Тестировать и проверить

## Ключевые вопросы
1. Какое error message появляется?
2. Какой файл обрабатывает authentication?
3. Что изменилось недавно?

## Принятые решения
- Auth handler в src/auth/login.ts
- Ошибка происходит в validateToken() функции

## Встреченные ошибки
- [Initial] TypeError: Cannot read property 'token' of undefined
  → Корневая причина: user object не awaited правильно

## Status
**Currently in Phase 3** - Найдена корневая причина, готовим fix
```

## Паттерн восстановления после ошибок

### ❌ Неправильно
```
Action: Read config.json
Error: File not found
Action: Read config.json  # Молчаливый retry
Action: Read config.json  # Еще retry
```

### ✅ Правильно
```
Action: Read config.json
Error: File not found

# Обнови task_plan.md:
## Встреченные ошибки
- config.json not found → Создам default config

Action: Write config.json (default config)
Action: Read config.json
Success!
```

## Checklist

```
Planning with Files Review:
- [ ] task_plan.md создан перед началом работы
- [ ] Фазы определены (3-7 фаз)
- [ ] Цель четко сформулирована (одно предложение)
- [ ] findings.md обновляется после открытий
- [ ] progress.md ведется на протяжении сессии
- [ ] План перечитывается перед важными решениями
- [ ] Статусы фаз обновляются: pending → in_progress → complete
- [ ] Все ошибки залогированы в task_plan.md
- [ ] Неудачные действия не повторяются
- [ ] Визуальная информация сохраняется как текст (правило 2-х действий)
- [ ] Можешь ответить на 5 вопросов перезагрузки
```

## Антипаттерны

| ❌ Не делай | ✅ Делай вместо этого |
|-------------|----------------------|
| Начинай выполнение немедленно | Создай файл плана СНАЧАЛА |
| Формулируй цели один раз и забывай | Перечитывай план перед решениями |
| Скрывай ошибки и повторяй молча | Логируй ошибки в файл плана |
| Запихивай всё в контекст | Храни большой контент в файлах |
| Повторяй неудачные действия | Отслеживай попытки, меняй подход |
| Игнорируй визуальную информацию | Сохраняй после каждых 2 view операций |

## Статистика Manus

| Метрика | Значение |
|---------|----------|
| Средние tool calls на задачу | ~50 |
| Соотношение входных/выходных токенов | 100:1 |
| Цена приобретения | $2 млрд |
| Время до $100M выручки | 8 месяцев |
| KV-cache hit rate | Самая важная метрика |
| Кешированные токены | $0.30/MTok |
| Некешированные токены | $3/MTok |
| Разница в стоимости | 10x |

## Ключевые цитаты

> "Context window = RAM (volatile, limited). Filesystem = Disk (persistent, unlimited). Anything important gets written to disk."

> "if action_failed: next_action != same_action. Track what you tried. Mutate the approach."

> "Error recovery is one of the clearest signals of TRUE agentic behavior."

> "KV-cache hit rate is the single most important metric for a production-stage AI agent."

> "Leave the wrong turns in the context."

## Автоматизация с хуками (уже установлены!)

Kiro CLI включает **глобальные хуки** для planning-with-files:
- `planning-with-files.json` - автоматически показывает план перед промптом
- `planning-check-complete.json` - проверяет завершение фаз после ответа

**Хуки работают автоматически** для всех агентов. Ничего настраивать не нужно!

Подробности в `hooks/README.md`.

## Дополнительные материалы (steering)

Для детальных workflow guides и примеров смотри:
- `steering/examples.md` - Детальные примеры использования
- `steering/manus-principles.md` - Полное описание принципов Manus
- `steering/templates.md` - Готовые шаблоны для копирования
- `hooks/README.md` - Автоматизация с Kiro CLI хуками

## Ресурсы

- [Manus Context Engineering](https://manus.im/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus)
- [Original planning-with-files plugin](https://github.com/OthmanAdi/planning-with-files)
- [Kiro CLI Hooks Documentation](https://kiro.dev/docs/cli/hooks/)
